import 'package:adhan/adhan.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:geolocator/geolocator.dart';
import 'package:timezone/data/latest_all.dart' as tz;
import 'package:timezone/timezone.dart' as tz;

class NotificationServices {
  static FlutterLocalNotificationsPlugin flutterLocalNotificationsPlugin =
      FlutterLocalNotificationsPlugin();

  static Future init() async {
    AndroidInitializationSettings initializationSettingsAndroid =
        AndroidInitializationSettings('@mipmap/ic_launcher');
    final InitializationSettings initializationSettings =
        InitializationSettings(android: initializationSettingsAndroid);
    await flutterLocalNotificationsPlugin.initialize(initializationSettings);
  }
static List<String> azkarList = [
  "Ø£ØµØ¨Ø­Ù†Ø§ ÙˆØ£ØµØ¨Ø­ Ø§Ù„Ù…Ù„Ùƒ Ù„Ù„Ù‡ ğŸŒ¸",
  "Ø§Ù„Ù„Ù‡Ù… Ø¨Ùƒ Ø£ØµØ¨Ø­Ù†Ø§ ÙˆØ¨Ùƒ Ø£Ù…Ø³ÙŠÙ†Ø§ â˜€ï¸",
  "Ø±Ø¶ÙŠØª Ø¨Ø§Ù„Ù„Ù‡ Ø±Ø¨Ù‹Ø§ ÙˆØ¨Ø§Ù„Ø¥Ø³Ù„Ø§Ù… Ø¯ÙŠÙ†Ù‹Ø§ ÙˆØ¨Ù…Ø­Ù…Ø¯ ï·º Ù†Ø¨ÙŠÙ‹Ø§",
  "Ø§Ù„Ù„Ù‡Ù… Ù…Ø§ Ø£ØµØ¨Ø­ Ø¨ÙŠ Ù…Ù† Ù†Ø¹Ù…Ø© ÙÙ…Ù†Ùƒ ÙˆØ­Ø¯Ùƒ",
  "Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡ ÙˆØ­Ø¯Ù‡ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„Ù‡"
];

  static Future showNotification(DateTime start,DateTime end,Duration interval) async {
  int  id=0;
    const NotificationDetails android = NotificationDetails(
      android: AndroidNotificationDetails(
        "channelId",
        "channelName",
        importance: Importance.high,
        priority: Priority.high,
      ),
    );
    tz.initializeTimeZones();
   tz.TZDateTime scheduledTime= tz.TZDateTime.from(start,tz.local);
    for (var i = 0; i< azkarList.length ;i++) {
  await flutterLocalNotificationsPlugin.zonedSchedule(
    id++,
    'ğŸ•Œ Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­',
    azkarList[i],
  
   // tz.TZDateTime.now(tz.local).add(const Duration(seconds: 5)),
  scheduledTime,
    android,
    matchDateTimeComponents: DateTimeComponents.time,
  
    androidScheduleMode: AndroidScheduleMode.exactAllowWhileIdle,
  );
    // Ù†Ø²ÙˆØ¯ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ù„ÙŠ Ø­Ø¯Ø¯Ù‡ Ø§Ù„ÙŠÙˆØ²Ø±
    scheduledTime = scheduledTime.add(interval);
}
  }

  void cancleAllNotification() async {
    await flutterLocalNotificationsPlugin.cancelAll();
  }

  static Future<void> notification({
    required String title,
    required String body,
    required int id,
    required DateTime time,
  }) async {
        tz.initializeTimeZones();
    final tzTime = tz.TZDateTime.from(time, tz.local);
    const NotificationDetails android = NotificationDetails(
      android: AndroidNotificationDetails(
        "channelId",
        "channelName",
        importance: Importance.high,
        priority: Priority.high,
      ),
    );

    await flutterLocalNotificationsPlugin.zonedSchedule(
      id,
      title,
      body,

      tzTime,

      android,
      matchDateTimeComponents: DateTimeComponents.time,

      androidScheduleMode: AndroidScheduleMode.exactAllowWhileIdle,
    );
  }

  // This will be called daily by AlarmManager
  @pragma('vm:entry-point')
  static Future<void> runDailyAzkarTask() async {
    tz.initializeTimeZones();
  // Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¯Ø§Ø®Ù„ isolate
  await NotificationServices.init();
    // Get location
    final position = await Geolocator.getCurrentPosition(
      desiredAccuracy: LocationAccuracy.high,
    );

    final coordinates = Coordinates(position.latitude, position.longitude);
    final params = CalculationMethod.egyptian.getParameters();
    final prayerTimes = PrayerTimes.today(coordinates, params);

    // Schedule Fajr or Sunrise for Azkar Al-Sabah
final now = DateTime.now();
final testTime = now.add(Duration(minutes: 1));

await notification(
  id: 1,
  title: 'ğŸ•Œ Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­',
  body: 'Ø§Ø¨Ø¯Ø£ ÙŠÙˆÙ…Ùƒ Ø¨Ø°ÙƒØ± Ø§Ù„Ù„Ù‡ ğŸŒ',
  time:     tz.TZDateTime.now(tz.local).add(const Duration(seconds: 5)),
);


    // // Schedule Asr for Azkar Al-Masa
    // await notification(
    //   id: 2,
    //   title: 'ğŸŒ‡ Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡',
    //   body: 'Ù„Ø§ ØªÙ†Ø³Ù Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡ ğŸ•”',
    //   time: prayerTimes.asr,
    // );
  }
}
